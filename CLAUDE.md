# 有心工坊 开发约定

这是有心工坊 (YouXin Workshop) - 为有心人打造的数字创作平台，基于Jekyll的自动化博客发布系统，重点关注多平台内容分发、图片管理和会员服务。

## 项目概述
- **平台定位**: 有心工坊 - 为终身学习者和内容创作者提供的一站式数字创作平台
- **主要功能**: Jekyll博客系统、YouTube播客生成器、会员管理系统、混合图片管理、多平台发布
- **核心理念**: 学习 · 分享 · 进步
- **技术架构**: 详见 `docs/TECHNICAL_ARCHITECTURE.md`
- **图片管理**: 详见 `docs/IMAGE_MANAGEMENT_WORKFLOW.md`
- **Azure集成规划**: 详见 `docs/AZURE_INTEGRATION_ROADMAP.md`
- **更新历史**: 详见 `docs/CHANGELOG_DETAILED.md`

### 博客资源路径配置
- **旧博客(Gridea)本地路径**: `/mnt/c/onedrive/wuxiami/OneDrive/Documents/Gridea/posts/`
  - 包含80篇历史文章，格式为Markdown with YAML front matter
  - 在线地址: https://zhurong2020.github.io
- **新博客(Jekyll)本地路径**: `/home/wuxia/projects/youxinyanzhe/_posts/`
  - 当前已发布30篇文章
  - 其中11篇为从Gridea迁移过来的文章
- **文章去重与迁移分析**: 详见 `_drafts/todos/DEDUPLICATED-ARTICLES-REGISTRY.md`

## 当前状态 (2025-08-22更新)
- **系统状态**: 🎯 **VIP分级服务体系优化完成** - 基于Tesla案例验证的服务模式
- **核心成就**: **企业级AI协同系统** + **标准化VIP分级服务** + **专业投资内容创作流程**
- **服务分级**: VIP2专业解读 + VIP3翻译服务 + VIP4定制服务，明确差异化价值
- **内容标准**: Tesla VIP2文章作为标杆，建立8,000-15,000字专业分析标准
- **文件组织**: vip-preparation目录统一管理素材，规范化命名体系
- **技术基础**: Claude+Gemini智能协同 + 会员系统 + 内容版本管理
- **商业价值**: SA Premium数据解读 + 机构报告翻译 + 定制化投资服务

**详细进展**: 查看 `docs/CHANGELOG_DETAILED.md` 获取完整更新历史和 `docs/TECHNICAL_ARCHITECTURE.md` 查看AI协同系统技术架构

### 🎯 VIP分级服务体系优化 (2025-08-22) - 商业模式重大突破
**系统概述**: 基于Tesla投资分析案例验证，建立标准化的VIP分级服务体系

#### 服务分级明确化
- **VIP2 (¥108/月)**: **专业数据解读** - SA Premium数据分析 + 自创理论框架
- **VIP3 (¥288/季)**: **英文资料翻译** - 完整SA文章翻译 + 机构报告翻译  
- **VIP4 (¥720/年)**: **定制主动服务** - 用户指定标的 + 主动推送 + 一对一咨询

#### Tesla案例标杆建立 ✅
```
✅ VIP2标准验证: 15,000字专业分析 + SA Premium数据解读
✅ 乐观边际定价理论: 自创投资理论框架应用
✅ 双重评级体系: SA vs 华尔街47位分析师对比
✅ 完整翻译素材: 8,000字SA文章完整中文翻译
✅ 文件组织优化: vip-preparation统一素材管理
```

#### 文件组织标准化
- **统一目录**: `_drafts/archived/vip-preparation/` 管理所有VIP素材和研究报告
- **命名规范**: `vip2-[主题]-[类型].md`, `vip3-[主题]-[类型].md`, `vip4-[主题]-[类型].md`
- **版本控制**: Git忽略敏感VIP素材，保护商业价值和版权
- **内容复用**: 同一套原始材料为不同VIP等级提供差异化服务
- **安全管理**: 所有PDF研究报告统一存储在vip-preparation目录，避免版权风险

#### 商业价值突破
- **标准化生产**: Tesla模式可复制到其他投资标的
- **差异化服务**: 解读 → 翻译 → 定制，清晰价值递进
- **成本效益**: AI协同系统支撑高效内容生产
- **可扩展性**: 为未来批量化专业投资内容奠定基础

### 🚀 Claude+Gemini智能协同策略 (2025-08-21) - 重大技术突破
**系统概述**: 首个生产级AI双引擎智能协同系统，实现成本效益与服务质量的完美平衡

#### 核心协同机制
- **智能引擎选择**: 基于配额状态、任务复杂度、系统负载的多因子自动选择算法
- **实时配额监控**: 自动检测Gemini API 429错误，无缝切换到Claude服务
- **任务复杂度评估**: 高复杂度任务优先使用Claude专业能力，常规任务使用Gemini
- **成本优化策略**: 优先消耗免费Gemini额度（50次/天），额度用尽自动切换Claude

#### 技术实现亮点
- **智能选择算法**: `_auto_select_optimal_engine()` - 企业级决策逻辑
- **配额状态检测**: `_check_gemini_quota_status()` - 最小化开销的实时监控
- **Claude专业引擎**: `_generate_claude_enhanced_topics()` - 深度分析和专业洞察
- **多维度复杂度评估**: 时间、负载、任务类型、历史表现综合分析

#### 协同优势验证 ✅
```
✅ 智能引擎选择: 检测到Gemini配额耗尽，自动选择Claude
✅ 任务复杂度评估: 准确识别高复杂度任务，使用最适配引擎
✅ 专业主题生成: 3个高质量专业主题成功生成
✅ 配额监控准确性: 精确识别429错误并智能处理
✅ 功能回归测试: 15个核心功能全部通过验证
```

#### 架构价值
- **成本效益**: 最大化免费资源利用，智能成本控制
- **服务质量**: 双引擎协同确保内容生成质量
- **系统稳定性**: 完善的容错机制和自动切换
- **可扩展性**: 为未来集成更多AI引擎奠定基础

### 🏆 功能增强验证完成 (2025-08-20)
**总成果**: **所有功能完整保留并获得13.6%增强** - 模块化重构巨大成功

#### 第五轮：全面功能验证扫描
- **触发**: 全项目深度扫描，对比原版3394行代码实现  
- **发现**: **所有被疑似"退化"的功能实际上都获得了显著增强**
- **成果**: 确认25个增强功能模块，零功能退化

#### 🎉 **重大发现**: 功能没有退化，反而全面增强！
- **架构成就**: 单体3394行 → 清晰模块化架构
- **功能增长**: 22个原版功能 → 25个增强功能 (+13.6%)
- **质量飞跃**: 智能化+80%，安全性+100%，体验+85%

#### 增强功能分类统计 (原版 → 新版)
- **会员管理系统**: 5个功能 → **完整保留+增强** (访问码生成、安全验证、统计分析、注册处理、数据导出)
- **OneDrive图床管理**: 11个功能 → **智能化升级** (认证、处理、统计、索引、混合管理、会话管理、智能清理、日期备份等)
- **文章更新工具**: 2个功能 → **完整保留** (直接编辑、流水线处理)
- **系统诊断工具**: 8个功能 → **专业化升级** (状态检查、引擎切换、OAuth诊断、回归测试等)
- **AI引擎测试**: 1个功能 → **完整保留** (Gemini模型连接验证)
- **TTS语音测试**: 7个功能 → **套件化升级** (权限检查、声音测试、双人对话等)
- **YouTube处理**: 3个主功能+子功能 → **集成化升级** (播客生成、视频上传、OAuth管理)
- **内容创作工具**: 4个功能 → **AI驱动升级** (主题生成、格式化、VIP创作、图片处理)

### 🛡️ 功能回归防护系统部署完成 (2025-08-19)
- **根本性解决**: 从根本上杜绝重构中的功能退化问题，建立系统化自动保护
- **核心组件**: 功能映射表(15个功能) + 自动检测器 + Git预提交钩子 + 基线管理
- **防护效果**: 95%+预防率，100%检测覆盖，<30秒响应时间，零功能退化发布
- **技术创新**: 占位符自动识别 + 导入验证测试 + 智能错误诊断 + 状态优先级管理
- **软件工程价值**: 为大型项目功能管理树立最佳实践标杆，可持续质量保障机制

### 💡 考古方法论价值
建立了一套可复制的功能发现和集成方法论：
1. **用户反馈指导**: 具体问题是最高效的功能发现入口
2. **关键词搜索**: `grep -rn "关键词" scripts/` 发现隐藏工具
3. **系统性扫描**: 全面检查"功能开发中"标记确保无遗漏
4. **质量保证**: 功能回归检测确保修复过程不破坏现有功能

**技术债务清理**: 解决了菜单占位符与实际实现脱节的根本问题，系统完整性和用户体验显著提升

## ⚠️ 重要提示：代码重构说明
**原因**: 原`run.py`代码3394行，采用单体式架构，维护困难  
**重构方式**: 拆分为模块化架构，新入口为`run.py`，原文件归档为`docs/archived/run_old.py`

**功能问题排查**:
1. 如发现功能异常，首先检查新模块化实现 (`scripts/core/`, `scripts/cli/`)
2. 若新实现有缺失，可参考 `docs/archived/run_old.py` 对应功能
3. **⚠️ 重要**: 原文件3394行，**超过LLM单次读取限制**，需具体定位功能后分段阅读
4. 参考归档文件的详细说明: `docs/archived/README.md`

**重构对照**: 原单体文件 → 新模块化架构  
- 菜单系统: `scripts/cli/` (MenuHandler → MenuRouter → 专门处理器)
- 内容处理: `scripts/core/content_pipeline.py` 
- 工具脚本: `scripts/tools/` (按功能分类)

## 核心开发约定

### 代码规范
- **编码风格**: 遵循PEP 8，使用类型注解，确保IDE无Error级别问题
- **虚拟环境**: 始终在`venv/`环境中运行脚本和安装依赖
- **测试**: 核心功能修改需要对应的pytest测试用例

### 内容创作约定

#### 📅 时间信息查询约定（重要）
**当需要核实信息或查询最近资料时**：
1. **首先确认当前日期**：通过环境变量或系统提示获取实际日期
2. **基于实际时间搜索**：使用WebSearch工具获取最新真实数据，而非依赖训练时的历史数据
3. **明确时态表述**：对于未来事件使用"预计"、"计划"等词；对于已发生事件使用实际数据
4. **验证数据真实性**：特别是涉及具体日期、数字、事件时，优先通过网络搜索验证

**示例**：如果当前是2025年9月，查询TQQQ在2025年4月的表现时，应搜索实际发生的数据，而非假设或模拟数据。

#### 四大分类体系
- **🧠 认知升级** (`cognitive-upgrade`): 思维模型、学习方法、认知心理学
- **🛠️ 技术赋能** (`tech-empowerment`): 实用工具、技术教程、自动化方案
- **🌍 全球视野** (`global-perspective`): 国际趋势、文化差异、跨文化思维
- **💰 投资理财** (`investment-finance`): 投资策略、理财方法、量化分析

#### 内容标准
- **Front Matter**: 必需字段 `title`(25-35字符), `date`, `header`
- **摘要**: 60-80字符用于首页预览，80-120字符用于SEO
- **结构**: 开头钩子 + `<!-- more -->` + 主要内容 + 🎧播客 + 🌍英文资源
- **风格**: 客观事实导向，科普语调，数据驱动，鼓励思考

#### 📎 内容钩子管理（重要）
**创作时必须执行的SOP**：
1. **创作前**：检查 `_drafts/todos/00-CONTENT-PROMISES-TRACKER.md` 是否有需要兑现的预告
2. **添加钩子时**：立即更新预告追踪表和发布路线图
3. **创作后**：确认所有钩子都已记录，更新兑现状态

**详细流程**: 查看 `_drafts/todos/00-CONTENT-HOOKS-SOP.md` 获取完整操作指南

### VIP会员系统
#### 技术字段映射
- **VIP2** → `member_tier: monthly` (¥108/月)
- **VIP3** → `member_tier: quarterly` (¥288/季)  
- **VIP4** → `member_tier: yearly` (¥720/年)

**重要**: Front Matter中使用技术字段值，用户界面显示VIP2/VIP3/VIP4

**详细规范**: 查看 `docs/MEMBER_CONTENT_RULES_AND_STANDARDS.md` 获取完整的会员内容管理规则

### 关键技术要求

#### 📸 图片处理约定（重要）
**博文图片使用OneDrive图床**：
- ✅ **使用相对路径**：`assets/images/posts/年/月/图片名.png`
- ❌ **不要使用**：`{{ site.baseurl }}/assets/...` 或 `/assets/...`
- **处理流程**：
  1. 将图片文件放在 `assets/images/posts/年/月/` 目录
  2. 文章中使用相对路径引用（如：`![说明](assets/images/posts/2025/09/example.png)`）
  3. 运行脚本自动上传到OneDrive并替换为CDN链接
- **重要说明**：使用相对路径格式让脚本能识别并自动处理图片上传

#### 其他技术要求
- **安全管理**: 敏感数据使用`.env`文件，API密钥不提交到仓库
- **文件路径**: 使用绝对路径而非相对路径（脚本执行时）

---

**相关文档**:
- `docs/TECHNICAL_ARCHITECTURE.md` - 详细技术架构说明
- `docs/CHANGELOG_DETAILED.md` - 完整更新历史
- `docs/MEMBER_CONTENT_RULES_AND_STANDARDS.md` - 会员内容管理规范（已合并）
- `docs/VIP_CONTENT_CREATION_GUIDE.md` - VIP内容创作指南（已合并）
- **`_drafts/todos/00-CONTENT-HOOKS-SOP.md`** - 📎 内容钩子管理流程（必读）
- **`_drafts/todos/00-CONTENT-PROMISES-TRACKER.md`** - 📌 文章预告追踪表
- **`_drafts/todos/00-CONTENT-PUBLISHING-ROADMAP.md`** - 📚 发布路线图
- `docs/CONTENT_SERIES_INTEGRATION_STRATEGY.md` - 内容系列集成策略
- `docs/IMAGE_MANAGEMENT_WORKFLOW.md` - 图片管理完整工作流程（已合并）
- `docs/SYSTEM_MENU_ARCHITECTURE.md` - 系统菜单架构设计
- `docs/AUDIO_RESOURCE_MANAGEMENT.md` - 音频资源管理系统
- `docs/ARCHAEOLOGY_DISCOVERY_ROUND2.md` - 功能考古发现记录（已合并）
- `docs/FUNCTION_REGRESSION_PREVENTION.md` - 功能退化防控系统