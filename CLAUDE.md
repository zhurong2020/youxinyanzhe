# Claude Code 开发约定

这是一个基于Jekyll的自动化博客发布系统，重点关注多平台内容分发和会员管理。

## 项目概述
- **主要功能**: Jekyll博客系统、YouTube播客生成器、会员管理系统、OneDrive图床自动化、多平台发布
- **技术架构**: 详见 `docs/TECHNICAL_ARCHITECTURE.md`
- **图片管理**: 详见 `docs/IMAGE_MANAGEMENT_WORKFLOW.md`
- **Azure集成规划**: 详见 `docs/AZURE_INTEGRATION_ROADMAP.md`
- **更新历史**: 详见 `docs/CHANGELOG_DETAILED.md`

## 当前工作重点
- **Phase 1 (已完成)**: 内容创作与数据观察 + 系统重构优化 - OneDrive图床自动化已完成，菜单系统重构完成(14项→9项)
- **Phase 1.5 (即将开始)**: Azure AI服务集成 - Azure OpenAI Service和Azure AI Speech替换现有服务，优化成本和质量
- **Phase 2 (2-3月后)**: 喜马拉雅平台集成 - OAuth认证、音频上传、智能平台选择
- **Phase 3 (3-6月后)**: 社区功能与高级服务 - Discord社区、深度投资服务

## 🎯 最新重构成果 (2025-08-11)
### 系统菜单重构完成
- **简化程度**: 14项精简为9项，减少36%选择复杂度
- **工作流程**: 创作→规范化→发布的逻辑更加清晰
- **功能整合**: 相关功能一站式处理，智能重定向支持
- **用户体验**: 选择困难减少，操作效率显著提升

### 新菜单架构
```
📝 内容工作流程：
1. 智能内容发布      # 统一发布入口(原1+2)
2. 内容规范化处理    # 核心处理功能
3. 智能内容创作      # AI驱动创作(原5+3)
4. YouTube内容处理   # 完整视频流程(原8+13)

🛠️ 系统管理：
5. OneDrive图床管理  # 图片资源管理
6. 内容变现管理      # 会员服务管理
7. 语音和音频工具    # TTS服务集成(原12+相关)
8. 文章更新工具      # 内容维护功能
9. 系统工具集合      # 系统维护(原7+10+11)
```

## 博客创作工作流程
### 完整创作流程 (已实现并增强)
1. **内容创作**: 使用灵感生成器或手动创建草稿文件
2. **图片准备**: 搜索/创作图片，保存到`assets/images/posts/YYYY/MM/`
3. **图片引用**: 在草稿中使用本地路径引用图片  
4. **图床处理**: 增强的OneDrive图床管理流程
   - **基础流程**: `run.py` → OneDrive图床管理 → 处理单个草稿
   - **增强流程**: `enhanced_onedrive_processor.py` → 带回退机制的完整处理
   - 上传图片到OneDrive (`/BlogImages/{year}/{month}/`)
   - 生成**可直接渲染**的Jekyll图片链接 (已修复渲染问题)
   - 替换文章中的图片链接为OneDrive直接链接
   - 删除本地assets目录中的原文件
   - 记录完整索引到`_data/onedrive_image_index.json`
   - **新增**: 自动创建处理前快照 + GitHub Release备份
5. **文章发布**: 移动到`_posts/`目录，Jekyll自动构建

### 回退和恢复机制 (新增)
- **自动快照**: 处理前自动备份文章内容和本地图片
- **失败回退**: 处理失败时自动恢复到原始状态
- **手动恢复**: 可从任意快照ID手动回退
- **GitHub备份**: 完整的文章+图片资源备份到GitHub Release

## 核心开发约定

### 代码规范
- **编码风格**: 遵循PEP 8，使用类型注解和显式类型转换
- **类型检查**: 修改代码后必须检查IDE中的类型错误提示，确保无Error级别问题
  - 使用 `Optional[str]` 而非 `str = None` 
  - 函数参数类型必须明确，避免 `None` 类型冲突
  - 未使用参数可用 `_` 占位符代替具体参数名
  - **注意**: IDE中的Problems有时需要重启IDE才能生效
- **测试**: 核心业务逻辑修改需要对应的pytest测试用例
- **虚拟环境**: 始终在`venv/`环境中运行脚本和安装依赖

### 内容创作约定
#### 四大分类体系
- **🧠 认知升级** (`cognitive-upgrade`): 思维模型、学习方法、认知心理学
- **🛠️ 技术赋能** (`tech-empowerment`): 实用工具、技术教程、自动化方案
- **🌍 全球视野** (`global-perspective`): 国际趋势、文化差异、跨文化思维
- **💰 投资理财** (`investment-finance`): 投资策略、理财方法、量化分析

#### 内容标准
- **Front Matter**: 必需字段 `title`(25-35字符), `date`, `header`
- **摘要**: 50-60字符，用于首页预览
- **结构**: 开头钩子 + `<!-- more -->` + 主要内容 + 🎧播客 + 🌍英文资源
- **风格**: 客观事实导向，科普语调，数据驱动，鼓励思考

### 关键技术要求
#### Jekyll资源路径 (关键)
- **必须使用**: `{{ site.baseurl }}/assets/...` (因为使用baseurl="/youxinyanzhe"部署)
- **禁止使用**: 绝对路径如 `/assets/images/...`
- **测试**: 在本地Jekyll服务器和GitHub Pages上都要测试

#### 安全约定
- **敏感数据**: 使用`.env`文件，排除于版本控制
- **API密钥**: 从不提交密钥到仓库
- **访问控制**: 限制API权限到最小所需范围

---

**相关文档**:
- `docs/TECHNICAL_ARCHITECTURE.md` - 详细技术架构说明
- `docs/CHANGELOG_DETAILED.md` - 完整更新历史
- `docs/project-completion-summary.md` - 项目完成状态总结