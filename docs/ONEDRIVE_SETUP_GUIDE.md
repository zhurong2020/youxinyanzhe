# OneDriveåšå®¢å›¾åºŠè®¾ç½®æŒ‡å—

## ğŸ“‹ å‰æœŸå‡†å¤‡

### 1. Azureåº”ç”¨æ³¨å†Œ

1. **è®¿é—®Azure Portal**
   - æ‰“å¼€ [https://portal.azure.com/](https://portal.azure.com/)
   - ä½¿ç”¨å¼€å‘è€…è´¦å· `zhurong@7fp1fj.onmicrosoft.com` ç™»å½•

2. **æ³¨å†Œæ–°åº”ç”¨**
   ```
   è·¯å¾„: Azure Active Directory â†’ åº”ç”¨æ³¨å†Œ â†’ æ–°æ³¨å†Œ
   
   é…ç½®:
   - åç§°: BlogImageManager
   - æ”¯æŒçš„å¸æˆ·ç±»å‹: ä»…æ­¤ç»„ç»‡ç›®å½•ä¸­çš„å¸æˆ·
   - é‡å®šå‘ URI: Web - http://localhost:8080/callback
   ```

3. **é…ç½®APIæƒé™**
   ```
   è·¯å¾„: åº”ç”¨ â†’ APIæƒé™ â†’ æ·»åŠ æƒé™
   
   æ·»åŠ æƒé™:
   - Microsoft Graph â†’ å§”æ‰˜çš„æƒé™ â†’ Files.ReadWrite
   - Microsoft Graph â†’ å§”æ‰˜çš„æƒé™ â†’ Sites.ReadWrite.All
   ```

4. **åˆ›å»ºå®¢æˆ·ç«¯å¯†ç **
   ```
   è·¯å¾„: åº”ç”¨ â†’ è¯ä¹¦å’Œå¯†ç  â†’ æ–°å»ºå®¢æˆ·ç«¯å¯†ç 
   
   è®¾ç½®:
   - è¯´æ˜: BlogImageManager Secret
   - è¿‡æœŸæ—¶é—´: 24ä¸ªæœˆ
   
   âš ï¸ é‡è¦: ç«‹å³å¤åˆ¶å¯†ç å€¼ï¼Œç¨åæ— æ³•æŸ¥çœ‹ï¼
   ```

5. **è·å–åº”ç”¨ä¿¡æ¯**
   ```
   éœ€è¦è®°å½•çš„ä¿¡æ¯:
   - åº”ç”¨ç¨‹åº(å®¢æˆ·ç«¯) ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   - å®¢æˆ·ç«¯å¯†ç : åˆšæ‰åˆ›å»ºçš„å¯†ç å€¼
   - ç›®å½•(ç§Ÿæˆ·) ID: 7fp1fj.onmicrosoft.com
   ```

### 2. é…ç½®ç³»ç»Ÿ

1. **æ›´æ–°é…ç½®æ–‡ä»¶**
   ```bash
   ç¼–è¾‘ config/onedrive_config.json
   
   å¡«å…¥è·å¾—çš„ä¿¡æ¯:
   {
     "auth": {
       "tenant_id": "7fp1fj.onmicrosoft.com",
       "client_id": "ä½ çš„å®¢æˆ·ç«¯ID",
       "client_secret": "ä½ çš„å®¢æˆ·ç«¯å¯†ç ",
       "redirect_uri": "http://localhost:8080/callback",
       ...
     }
   }
   ```

2. **å®‰è£…Pythonä¾èµ–**
   ```bash
   pip install requests
   ```

## ğŸš€ åˆå§‹åŒ–è®¾ç½®

### æ–¹æ³•1: é€šè¿‡run.pyï¼ˆæ¨èï¼‰
```bash
python run.py
# é€‰æ‹©: 14. OneDriveå›¾åºŠç®¡ç†
# é€‰æ‹©: 1. åˆå§‹åŒ–OneDriveè®¤è¯
```

### æ–¹æ³•2: ç›´æ¥è¿è¡Œè„šæœ¬
```bash
python scripts/tools/onedrive_blog_images.py --setup
```

### æ–¹æ³•3: å¿«é€Ÿè„šæœ¬
```bash
bash scripts/quick_onedrive_images.sh --setup
```

## ğŸ” è®¤è¯æµç¨‹

1. **å¯åŠ¨è®¤è¯**
   - ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
   - è®¿é—®Microsoftç™»å½•é¡µé¢

2. **ç™»å½•æˆæƒ**
   - ä½¿ç”¨å¼€å‘è€…è´¦å·ç™»å½•: `zhurong@7fp1fj.onmicrosoft.com`
   - åŒæ„åº”ç”¨æƒé™è¯·æ±‚

3. **å®Œæˆè®¤è¯**
   - æµè§ˆå™¨æ˜¾ç¤º "Authorization Successful!"
   - ç³»ç»Ÿè‡ªåŠ¨è·å–å¹¶ä¿å­˜è®¿é—®ä»¤ç‰Œ
   - è®¤è¯ä¿¡æ¯å­˜å‚¨åœ¨ `config/onedrive_tokens.json`

4. **éªŒè¯è¿æ¥**
   - ç³»ç»Ÿä¼šæµ‹è¯•OneDriveè¿æ¥
   - æ˜¾ç¤ºå­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### åšå®¢å†™ä½œå·¥ä½œæµ

1. **å†™ä½œé˜¶æ®µ**
   ```markdown
   åœ¨Markdownä¸­æ­£å¸¸æ’å…¥æœ¬åœ°å›¾ç‰‡:
   ![å›¾ç‰‡æè¿°]({{ site.baseurl }}/assets/images/posts/2025/08/image1.png)
   ![å¦ä¸€å¼ å›¾](./local/path/image2.jpg)
   ```

2. **å›¾ç‰‡å¤„ç†**
   ```bash
   # æ–¹æ³•1: é€šè¿‡run.py
   python run.py â†’ 14. OneDriveå›¾åºŠç®¡ç† â†’ 2. å¤„ç†å•ä¸ªè‰ç¨¿çš„å›¾ç‰‡
   
   # æ–¹æ³•2: ç›´æ¥å¤„ç†
   python scripts/tools/onedrive_blog_images.py --draft _drafts/my-article.md
   
   # æ–¹æ³•3: å¿«é€Ÿè„šæœ¬
   bash scripts/quick_onedrive_images.sh -d _drafts/my-article.md
   ```

3. **æ‰¹é‡å¤„ç†**
   ```bash
   # å¤„ç†æ‰€æœ‰è‰ç¨¿
   python scripts/tools/onedrive_blog_images.py --batch _drafts
   
   # æˆ–é€šè¿‡run.py â†’ 14 â†’ 3
   ```

### å¤„ç†ç»“æœ

ç³»ç»Ÿä¼šè‡ªåŠ¨:
1. æ£€æµ‹Markdownä¸­çš„æœ¬åœ°å›¾ç‰‡é“¾æ¥
2. ä¸Šä¼ å›¾ç‰‡åˆ°OneDriveçš„ `/BlogImages/YYYY/MM/` ç»“æ„
3. è·å–å›¾ç‰‡çš„åµŒå…¥å¼åˆ†äº«é“¾æ¥
4. æ›¿æ¢åŸæ–‡ä¸­çš„æœ¬åœ°é“¾æ¥

**æ›¿æ¢ç¤ºä¾‹**:
```markdown
# å¤„ç†å‰
![æˆªå›¾]({{ site.baseurl }}/assets/images/posts/2025/08/screenshot.png)

# å¤„ç†å  
![æˆªå›¾](https://onedrive.live.com/embed?resid=xxx&authkey=xxx&width=800)
```

## ğŸ“ OneDriveç›®å½•ç»“æ„

```
/BlogImages/
â”œâ”€â”€ 2025/
â”‚   â”œâ”€â”€ 08/
â”‚   â”‚   â”œâ”€â”€ 20250808_ä¿¡æ¯æ ¸å®æ–¹æ³•è®º_01.png
â”‚   â”‚   â”œâ”€â”€ 20250808_ä¿¡æ¯æ ¸å®æ–¹æ³•è®º_02.webp
â”‚   â”‚   â””â”€â”€ 20250808_AIåŒ»ç–—_01.jpg
â”‚   â””â”€â”€ 09/
â””â”€â”€ metadata/
    â””â”€â”€ upload_log.json
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. è¿æ¥çŠ¶æ€æ£€æŸ¥
```bash
# é€šè¿‡run.py â†’ 14 â†’ 4
# æ˜¾ç¤º:
# - OneDriveè¿æ¥çŠ¶æ€
# - å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
# - å¯ç”¨ç©ºé—´ç»Ÿè®¡
```

### 2. å¤„ç†ç»Ÿè®¡æŸ¥çœ‹
```bash
# é€šè¿‡run.py â†’ 14 â†’ 5
# æ˜¾ç¤º:
# - æˆåŠŸä¸Šä¼ çš„å›¾ç‰‡æ•°é‡
# - å¤±è´¥å¤„ç†çš„å›¾ç‰‡æ•°é‡
# - æœ€è¿‘çš„å¤„ç†æ—¥å¿—
```

### 3. è‡ªå®šä¹‰é…ç½®
```json
// config/onedrive_config.json
{
  "onedrive": {
    "base_folder": "/BlogImages",           // åŸºç¡€æ–‡ä»¶å¤¹
    "folder_structure": "{year}/{month:02d}", // ç›®å½•ç»“æ„
    "filename_format": "{date}_{article_title}_{index:02d}.{ext}" // æ–‡ä»¶åæ ¼å¼
  },
  "processing": {
    "max_file_size_mb": 32,                // æœ€å¤§æ–‡ä»¶å¤§å°
    "compress_large_images": true,         // æ˜¯å¦å‹ç¼©å¤§å›¾ç‰‡
    "compression_quality": 85              // å‹ç¼©è´¨é‡
  },
  "links": {
    "type": "embed",                       // é“¾æ¥ç±»å‹
    "width": 800,                         // åµŒå…¥å®½åº¦
    "height": null                        // åµŒå…¥é«˜åº¦ (è‡ªåŠ¨)
  }
}
```

## â— æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è®¤è¯å¤±è´¥**
   ```
   é”™è¯¯: Token exchange failed
   è§£å†³: æ£€æŸ¥Azureåº”ç”¨é…ç½®ï¼Œç¡®è®¤é‡å®šå‘URIæ­£ç¡®
   ```

2. **ä¸Šä¼ å¤±è´¥**
   ```
   é”™è¯¯: Upload failed: 401 Unauthorized
   è§£å†³: ä»¤ç‰Œå¯èƒ½è¿‡æœŸï¼Œé‡æ–°è¿è¡Œè®¤è¯
   ```

3. **æ–‡ä»¶æ‰¾ä¸åˆ°**
   ```
   é”™è¯¯: Could not resolve local path
   è§£å†³: æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè·¯å¾„æ˜¯å¦æ­£ç¡®
   ```

4. **æ–‡ä»¶è¿‡å¤§**
   ```
   é”™è¯¯: File too large
   è§£å†³: å‹ç¼©å›¾ç‰‡æˆ–è°ƒæ•´max_file_size_mbé…ç½®
   ```

### æ—¥å¿—æ£€æŸ¥
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
cat logs/onedrive_blog_images.log

# å®æ—¶ç›‘æ§æ—¥å¿—
tail -f logs/onedrive_blog_images.log
```

### ä»¤ç‰Œç®¡ç†
```bash
# ä»¤ç‰Œæ–‡ä»¶ä½ç½®
config/onedrive_tokens.json

# æ‰‹åŠ¨æ¸…é™¤ä»¤ç‰Œ (é‡æ–°è®¤è¯)
rm config/onedrive_tokens.json
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å›¾ç‰‡ç®¡ç†
- ä½¿ç”¨æœ‰æ„ä¹‰çš„å›¾ç‰‡æ–‡ä»¶å
- ä¿æŒåˆç†çš„å›¾ç‰‡å¤§å° (å»ºè®®<5MB)
- æ‰¹é‡å¤„ç†å‰å…ˆæµ‹è¯•å•ä¸ªæ–‡ä»¶

### 2. å­˜å‚¨ä¼˜åŒ–
- å®šæœŸæ£€æŸ¥OneDriveä½¿ç”¨æƒ…å†µ
- æ¸…ç†ä¸å†éœ€è¦çš„æ—§å›¾ç‰‡
- åˆ©ç”¨5TBç©ºé—´ä¼˜åŠ¿

### 3. å·¥ä½œæµä¼˜åŒ–
- å…ˆå®Œæˆæ–‡ç« å†™ä½œï¼Œæœ€åå¤„ç†å›¾ç‰‡
- ä½¿ç”¨æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡
- ä¿ç•™æœ¬åœ°å¤‡ä»½ç›´åˆ°ç¡®è®¤ä¸Šä¼ æˆåŠŸ

### 4. å¼€å‘æ´»åŠ¨åˆè§„
- å›¾ç‰‡ä¸Šä¼ æ“ä½œç®—ä½œGraph APIå¼€å‘æ´»åŠ¨
- æœ‰åŠ©äºMicrosoft 365 E5 Developerè®¢é˜…ç»­è®¢
- ä¿æŒåˆç†çš„ä½¿ç”¨é¢‘ç‡

## ğŸ”„ ç»­è®¢è´¡çŒ®

è¿™ä¸ªå›¾åºŠç³»ç»Ÿå¯¹Microsoft 365å¼€å‘è€…è®¢é˜…ç»­è®¢çš„è´¡çŒ®:
- âœ… çœŸå®çš„Graph APIå¼€å‘å’Œä½¿ç”¨
- âœ… æŒç»­çš„OneDriveæ–‡ä»¶æ“ä½œ
- âœ… åˆè§„çš„å¼€å‘ç›®çš„ä½¿ç”¨
- âœ… ä¸°å¯Œçš„APIè°ƒç”¨è®°å½•

æ¯æ¬¡ä½¿ç”¨éƒ½åœ¨ä¸ºç»­è®¢åŠ åˆ†ï¼ğŸ‰