<!-- ä¼šå‘˜å‡çº§æ¨¡æ€æ¡†å’ŒJavaScriptåŠŸèƒ½ -->
<div id="upgrade-modal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">å‡çº§ä¼šå‘˜</h3>
      <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modal-body">
      <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡ŒåŠ è½½ -->
    </div>
  </div>
</div>

<script>
// ä¼šå‘˜å‡çº§æ¨¡æ€æ¡†åŠŸèƒ½
function showUpgradeModal(level) {
    const modal = document.getElementById('upgrade-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    
    // å®šä¹‰ä¸åŒç­‰çº§çš„å†…å®¹
    const upgradeContent = {
        'VIP2': {
            title: 'ğŸ¯ VIP2æœˆåº¦ä¼šå‘˜ï¼šä¸“ä¸šæ•°æ®è§£è¯»',
            price: 'Â¥108/æœˆ',
            features: [
                'âœ… Seeking Alpha Premiumæ•°æ®æ·±åº¦è§£è¯»',
                'âœ… åå°”è¡—åˆ†æå¸ˆè¯„çº§å’Œç›®æ ‡ä»·åˆ†æ', 
                'âœ… æ¯å‘¨å¸‚åœºçƒ­ç‚¹è¿½è¸ªå’ŒæŠ•èµ„æœºä¼š',
                'âœ… ä¸“ä¸šæŠ•èµ„æŠ¥å‘Šä¸­æ–‡ç¿»è¯‘',
                'âœ… åŸºç¡€æŠ•èµ„ç­–ç•¥æŒ‡å¯¼',
                'âœ… é‚®ä»¶è®¢é˜…å’ŒåŠæ—¶æ›´æ–°é€šçŸ¥'
            ],
            description: 'è·å–ä¸“ä¸šçº§åˆ«çš„æŠ•èµ„æ•°æ®åˆ†æï¼ŒåŸºäº$300+å¹´è´¹çš„æµ·å¤–è®¢é˜…æœåŠ¡ï¼Œä¸ºæ‚¨æä¾›æœ¬åœŸåŒ–è§£è¯»ã€‚',
            cta: 'VIP2æœˆåº¦ä¼šå‘˜ Â¥108/30å¤©',
            bgColor: '#3b82f6'
        },
        'VIP3': {
            title: 'ğŸ’¼ VIP3å­£åº¦ä¼šå‘˜ï¼šä¸ªäººå®æˆ˜åˆ†äº«',
            price: 'Â¥288/90å¤©',
            features: [
                'âœ… åŒ…å«VIP2æ‰€æœ‰åŠŸèƒ½',
                'âœ… ä¸ªäººæŠ•èµ„ç»„åˆé€æ˜åˆ†äº«',
                'âœ… çœŸå®äº¤æ˜“è®°å½•å’Œå†³ç­–è¿‡ç¨‹',
                'âœ… æ·±åº¦ç­–ç•¥åˆ†æå’Œå¤ç›˜æ€»ç»“',
                'âœ… VIP3ä¸“äº«å¾®ä¿¡ç¾¤äº¤æµ',
                'âœ… æ¯æœˆæŠ•èµ„ç­–ç•¥ç›´æ’­ç­”ç–‘',
                'âœ… ä¸ªæ€§åŒ–æŠ•èµ„å»ºè®®å’Œå’¨è¯¢'
            ],
            description: 'è·å–ä½œè€…çš„çœŸå®æŠ•èµ„ç»éªŒåˆ†äº«ï¼ŒåŒ…æ‹¬æˆåŠŸæ¡ˆä¾‹å’Œå¤±è´¥æ•™è®­ï¼Œä¸å¿—åŒé“åˆçš„æŠ•èµ„è€…æ·±åº¦äº¤æµã€‚',
            cta: 'VIP3å­£åº¦ä¼šå‘˜ Â¥288/90å¤©',
            bgColor: '#f59e0b'
        },
        'VIP4': {
            title: 'ğŸš€ VIP4å¹´åº¦ä¼šå‘˜ï¼šæ·±åº¦æœåŠ¡+é‡åŒ–å·¥å…·',
            price: 'Â¥720/365å¤©',
            features: [
                'âœ… åŒ…å«VIP2ã€VIP3æ‰€æœ‰åŠŸèƒ½',
                'âœ… å®Œæ•´é‡åŒ–äº¤æ˜“è½¯ä»¶æºç ',
                'âœ… Teslaä¸“ç”¨ç½‘æ ¼ç­–ç•¥å·¥å…·',
                'âœ… å†å²å›æµ‹æ•°æ®å’Œæ€§èƒ½æŠ¥å‘Š',
                'âœ… æ¯æœˆ2æ¬¡1å¯¹1æŠ•èµ„å’¨è¯¢ï¼ˆ30åˆ†é’Ÿï¼‰',
                'âœ… ç­–ç•¥ä¼˜åŒ–å’Œå‚æ•°è°ƒæ•´æŒ‡å¯¼',
                'âœ… å¹´åº¦ä¼šå‘˜ä¸“å±èµ„æºå’Œå·¥å…·åŒ…',
                'âœ… ä¼˜å…ˆè·å¾—æ–°ç­–ç•¥å’Œå·¥å…·æ›´æ–°'
            ],
            description: 'å…¨æ–¹ä½çš„æŠ•èµ„æœåŠ¡ä½“éªŒï¼ŒåŒ…å«ä¸“ä¸šå·¥å…·ã€ä¸ªäººå’¨è¯¢å’ŒæŒç»­æ”¯æŒï¼ŒåŠ©åŠ›æ‚¨çš„æŠ•èµ„æˆé•¿ä¹‹è·¯ã€‚',
            cta: 'VIP4å¹´åº¦ä¼šå‘˜ Â¥720/365å¤© (ä»…Â¥2/å¤©)',
            bgColor: '#8b5cf6'
        }
    };
    
    const content = upgradeContent[level];
    if (!content) {
        console.error('Unknown upgrade level:', level);
        return;
    }
    
    modalTitle.textContent = content.title;
    
    modalBody.innerHTML = `
        <div class="upgrade-modal-content">
            <div class="upgrade-hero" style="background: linear-gradient(135deg, ${content.bgColor}, ${content.bgColor}dd);">
                <h4 style="color: white; margin: 0; text-align: center;">
                    ${content.price}
                </h4>
                <p style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin: 8px 0 0 0; text-align: center;">
                    ${content.description}
                </p>
            </div>
            
            <div class="upgrade-features">
                <h5>ğŸ ä¼šå‘˜æƒç›Šè¯¦æƒ…ï¼š</h5>
                <ul class="features-list">
                    ${content.features.map(feature => `<li>${feature}</li>`).join('')}
                </ul>
            </div>
            
            <div class="upgrade-actions">
                <button class="btn-upgrade-primary" style="background: ${content.bgColor};" onclick="redirectToMemberPage('${level}')">
                    ${content.cta}
                </button>
                <p class="upgrade-note">
                    <small>ğŸ’¡ æç¤ºï¼šå‡çº§åç«‹å³è·å¾—è®¿é—®æƒé™ï¼Œæ”¯æŒå¾®ä¿¡/æ”¯ä»˜å®ä»˜æ¬¾</small>
                </p>
            </div>
            
            <div class="risk-reminder">
                <p style="font-size: 0.8em; color: #6b7280; text-align: center; margin-top: 15px;">
                    âš ï¸ é£é™©æç¤ºï¼šæ‰€æœ‰æŠ•èµ„å†…å®¹ä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚
                </p>
            </div>
        </div>
    `;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // è·Ÿè¸ªå‡çº§æ¨¡æ€æ¡†æ˜¾ç¤º
    trackMembershipAction('modal_shown', level);
}

function closeUpgradeModal() {
    const modal = document.getElementById('upgrade-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    trackMembershipAction('modal_closed', '');
}

function redirectToMemberPage(level) {
    // è·Ÿè¸ªå‡çº§æŒ‰é’®ç‚¹å‡»
    trackMembershipAction('upgrade_button_clicked', level);
    
    // é‡å®šå‘åˆ°ä¼šå‘˜é¡µé¢ï¼Œå¹¶å¸¦ä¸Šç›®æ ‡ç­‰çº§å‚æ•°
    window.location.href = `/members/?target=${level}`;
}

// åˆ†æè·Ÿè¸ªå‡½æ•°
function trackMembershipAction(action, level) {
    // Google Analytics 4 è·Ÿè¸ª
    if (typeof gtag !== 'undefined') {
        gtag('event', 'membership_interaction', {
            'action': action,
            'level': level,
            'page_title': document.title,
            'page_location': window.location.href
        });
    }
    
    // æ§åˆ¶å°è°ƒè¯•ä¿¡æ¯
    console.log(`ğŸ“Š Membership Action: ${action}`, { level, timestamp: new Date() });
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.addEventListener('click', function(event) {
    const modal = document.getElementById('upgrade-modal');
    if (event.target === modal) {
        closeUpgradeModal();
    }
});

// ESCé”®å…³é—­æ¨¡æ€æ¡†
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('upgrade-modal');
        if (modal && modal.style.display === 'flex') {
            closeUpgradeModal();
        }
    }
});

// é˜…è¯»æ—¶é—´è·Ÿè¸ªå¼•æµ
let readingStartTime = Date.now();
let hasShownTimeBasedModal = false;

// 3åˆ†é’Ÿåæ˜¾ç¤ºå¼•æµæç¤ºï¼ˆä»…å¯¹éä¼šå‘˜ç”¨æˆ·ï¼‰
setTimeout(() => {
    if (!hasShownTimeBasedModal && !localStorage.getItem('memberAccess')) {
        showReadingTimeModal();
        hasShownTimeBasedModal = true;
    }
}, 180000); // 3åˆ†é’Ÿ

function showReadingTimeModal() {
    // åˆ›å»ºéä¾µå…¥å¼çš„é˜…è¯»æ—¶é—´æç¤º
    const timeModal = document.createElement('div');
    timeModal.className = 'reading-time-modal';
    timeModal.innerHTML = `
        <div class="reading-time-content">
            <div class="reading-time-icon">ğŸ“š</div>
            <h4>æ‚¨å·²é˜…è¯»3åˆ†é’Ÿ</h4>
            <p>å–œæ¬¢è¿™ç¯‡æ·±åº¦åˆ†æå—ï¼Ÿå‡çº§VIP2è·å–æ›´å¤šä¸“ä¸šæŠ•èµ„æ´å¯Ÿ</p>
            <div class="reading-time-actions">
                <button onclick="showUpgradeModal('VIP2')" class="btn-reading-upgrade">
                    äº†è§£VIP2ä¼šå‘˜
                </button>
                <button onclick="closeReadingTimeModal()" class="btn-reading-later">
                    ç¨åå†è¯´
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(timeModal);
    
    setTimeout(() => {
        timeModal.classList.add('show');
    }, 100);
    
    trackMembershipAction('reading_time_modal_shown', 'VIP2');
}

function closeReadingTimeModal() {
    const modal = document.querySelector('.reading-time-modal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    
    trackMembershipAction('reading_time_modal_closed', '');
}
</script>

<style>
/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px 15px 25px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
    margin: 0;
    color: #374151;
    font-size: 1.2em;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: #f3f4f6;
    color: #374151;
}

.modal-body {
    padding: 0;
}

.upgrade-modal-content {
    padding: 0;
}

.upgrade-hero {
    padding: 25px;
    text-align: center;
    border-radius: 12px 12px 0 0;
}

.upgrade-features {
    padding: 25px;
}

.upgrade-features h5 {
    color: #374151;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.features-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.features-list li {
    padding: 8px 0;
    color: #4b5563;
    font-size: 0.9em;
    border-bottom: 1px solid #f3f4f6;
}

.features-list li:last-child {
    border-bottom: none;
}

.upgrade-actions {
    padding: 0 25px 25px 25px;
    text-align: center;
}

.btn-upgrade-primary {
    width: 100%;
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1em;
    transition: all 0.3s ease;
    margin-bottom: 15px;
}

.btn-upgrade-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

.upgrade-note {
    margin: 0;
    color: #6b7280;
}

/* é˜…è¯»æ—¶é—´æ¨¡æ€æ¡† */
.reading-time-modal {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    max-width: 320px;
    z-index: 999;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
}

.reading-time-modal.show {
    transform: translateY(0);
    opacity: 1;
}

.reading-time-content {
    text-align: center;
}

.reading-time-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.reading-time-content h4 {
    margin: 0 0 10px 0;
    color: #374151;
    font-size: 1.1em;
}

.reading-time-content p {
    margin: 0 0 15px 0;
    color: #6b7280;
    font-size: 0.9em;
    line-height: 1.4;
}

.reading-time-actions {
    display: flex;
    gap: 10px;
}

.btn-reading-upgrade {
    flex: 1;
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
}

.btn-reading-later {
    flex: 1;
    background: #f3f4f6;
    color: #6b7280;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
}

.btn-reading-upgrade:hover {
    background: #2563eb;
}

.btn-reading-later:hover {
    background: #e5e7eb;
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(30px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* ç§»åŠ¨ç«¯å“åº”å¼ */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 20px;
    }
    
    .reading-time-modal {
        right: 10px;
        bottom: 10px;
        left: 10px;
        max-width: none;
    }
    
    .reading-time-actions {
        flex-direction: column;
    }
}
</style>