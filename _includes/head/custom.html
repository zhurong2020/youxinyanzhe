<!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- Google Analytics 4 -->
{% if site.google_analytics_id %}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics_id }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  
  gtag('config', '{{ site.google_analytics_id }}', {
    // éšç§å‹å¥½è®¾ç½®
    'anonymize_ip': true,
    'allow_google_signals': false,
    'allow_ad_personalization_signals': false
  });
  
  // è‡ªå®šä¹‰ä¼šå‘˜çº§åˆ«è·Ÿè¸ª
  function trackMemberAccess(memberLevel, accessMethod = 'manual') {
    console.log('ğŸ“Š trackMemberAccessè¢«è°ƒç”¨');
    console.log('å‚æ•° - ä¼šå‘˜çº§åˆ«:', memberLevel);
    console.log('å‚æ•° - è®¿é—®æ–¹å¼:', accessMethod);
    console.log('gtagå‡½æ•°å­˜åœ¨:', typeof gtag !== 'undefined');
    
    if (typeof gtag !== 'undefined') {
      gtag('event', 'member_access', {
        'custom_parameter_1': memberLevel,
        'custom_parameter_2': accessMethod,
        'event_category': 'membership',
        'event_label': memberLevel
      });
      console.log('âœ… member_accessäº‹ä»¶å·²é€šè¿‡gtagå‘é€');
      
      // è®¾ç½®ç”¨æˆ·å±æ€§
      gtag('config', '{{ site.google_analytics_id }}', {
        'custom_map': {
          'custom_parameter_1': 'member_level',
          'custom_parameter_2': 'access_method'
        }
      });
      console.log('âœ… ç”¨æˆ·å±æ€§é…ç½®å·²æ›´æ–°');
    } else {
      console.error('âŒ gtagå‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•å‘é€Analyticsäº‹ä»¶');
    }
  }
  
  // éŸ³é¢‘å¹³å°åˆ‡æ¢è·Ÿè¸ª
  function trackPlatformSwitch(platform, userRegion) {
    gtag('event', 'platform_switch', {
      'platform': platform,
      'user_region': userRegion,
      'event_category': 'audio_platform',
      'event_label': platform + '_' + userRegion
    });
  }
  
  // å†…å®¹äº¤äº’è·Ÿè¸ª
  function trackContentInteraction(action, content_type, content_id = '') {
    gtag('event', action, {
      'content_type': content_type,
      'content_id': content_id,
      'event_category': 'content_interaction'
    });
  }
  
  // æš´éœ²åˆ°å…¨å±€ï¼Œä¾›å…¶ä»–è„šæœ¬ä½¿ç”¨
  window.analytics = {
    trackMemberAccess: trackMemberAccess,
    trackPlatformSwitch: trackPlatformSwitch,
    trackContentInteraction: trackContentInteraction
  };
  
  // è°ƒè¯•ä¿¡æ¯
  console.log('ğŸ¯ Google Analyticsåˆå§‹åŒ–å®Œæˆ');
  console.log('Analytics ID:', '{{ site.google_analytics_id }}');
  console.log('Analyticså‡½æ•°å·²å°±ç»ª:', !!window.analytics);
</script>
{% endif %}

<!-- Load custom CSS -->
<link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">

<!-- Custom CSS -->
<link rel="stylesheet" href="{{ '/assets/css/subscription.css' | relative_url }}">

<!-- Audio Platform Selector CSS -->
<link rel="stylesheet" href="{{ '/assets/css/audio-platform-selector.css' | relative_url }}">

<!-- Custom JavaScript -->
<script src="{{ '/assets/js/subscription.js' | relative_url }}" defer></script>

<!-- Audio Platform Selector JavaScript -->
<script src="{{ '/assets/js/audio-platform-selector.js' | relative_url }}" defer></script>

<!-- Member Analytics Integration -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // æ£€æŸ¥ç”¨æˆ·ä¼šå‘˜çŠ¶æ€å¹¶è·Ÿè¸ª
  const memberLevel = localStorage.getItem('memberLevel');
  const memberAccess = localStorage.getItem('memberAccess');
  
  if (memberLevel && memberAccess === 'true' && window.analytics) {
    // è·Ÿè¸ªä¼šå‘˜è®¿é—®
    window.analytics.trackMemberAccess(memberLevel, 'localStorage');
    
    // ä¸ºé¡µé¢æ·»åŠ ä¼šå‘˜çº§åˆ«æ ‡è¯†ï¼ˆç”¨äºåˆ†æï¼‰
    document.body.dataset.memberLevel = memberLevel;
  }
  
  // è·Ÿè¸ªå†…å®¹æŸ¥çœ‹
  if (window.analytics) {
    const pageType = document.body.classList.contains('single') ? 'article' : 'page';
    const contentId = window.location.pathname;
    
    window.analytics.trackContentInteraction('page_view', pageType, contentId);
  }
});
</script>

<!-- end custom head snippets --> 