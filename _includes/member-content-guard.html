{% comment %}
ä¼šå‘˜å†…å®¹è®¿é—®æ§åˆ¶
ä½¿ç”¨æ–¹æ³•: {% include member-content-guard.html tier="monthly" %}
{% endcomment %}

{% if page.member_tier and page.member_tier != 'free' %}
<div class="member-content-guard" data-tier="{{ page.member_tier }}">
  <div class="notice--warning">
    <h4><i class="fas fa-lock"></i> ä¼šå‘˜ä¸“äº«å†…å®¹</h4>
    <p>æ­¤å†…å®¹éœ€è¦ 
      {% case page.member_tier %}
        {% when 'experience' %}ä½“éªŒä¼šå‘˜ (VIP1)
        {% when 'monthly' %}æœˆåº¦ä¼šå‘˜ (VIP2) 
        {% when 'quarterly' %}å­£åº¦ä¼šå‘˜ (VIP3)
        {% when 'yearly' %}å¹´åº¦ä¼šå‘˜ (VIP4)
      {% endcase %}
      åŠä»¥ä¸Šæƒé™æ‰èƒ½æŸ¥çœ‹ã€‚
    </p>
    
    <!-- ç›´æ¥éªŒè¯ç è¾“å…¥åŒºåŸŸ -->
    <div class="inline-member-auth" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
      <div style="display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap;">
        <input type="text" id="quickAccessCode" placeholder="è¾“å…¥è®¿é—®ç å¿«é€Ÿè§£é”" 
               maxlength="20" autocomplete="off"
               style="flex: 1; min-width: 200px; max-width: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
        <button onclick="quickVerifyAccess()" 
                style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
          <i class="fas fa-unlock"></i> è§£é”å†…å®¹
        </button>
      </div>
      <div id="quick-auth-message" style="margin-top: 10px; text-align: center; display: none; padding: 8px; border-radius: 4px;"></div>
    </div>
    
    {% unless page.layout contains 'members' %}
    <p style="text-align: center; margin-top: 15px;">
      æˆ–è€…ï¼š
      <a href="{{ '/members/' | relative_url }}" class="btn btn--primary btn--small">
        <i class="fas fa-key"></i> å‰å¾€ä¼šå‘˜ä¸“åŒº
      </a>
      <a href="{{ '/member-signup/' | relative_url }}" class="btn btn--info btn--small">
        <i class="fas fa-user-plus"></i> åŠ å…¥ä¼šå‘˜
      </a>
    </p>
    {% endunless %}
  </div>
</div>

<script>
// æ£€æŸ¥ä¼šå‘˜è®¿é—®æƒé™ï¼ˆæ”¯æŒç®¡ç†å‘˜è®¿é—®ç ï¼‰
(function() {
  const pageRequiredTier = '{{ page.member_tier }}';
  const memberLevel = localStorage.getItem('memberLevel');
  const memberExpiry = localStorage.getItem('memberExpiry');
  
  // ä¼šå‘˜ç­‰çº§æƒé‡æ˜ å°„
  const tierWeight = {
    'experience': 1,
    'monthly': 2,
    'quarterly': 3,
    'yearly': 4,
    'admin': 999  // ç®¡ç†å‘˜æœ€é«˜æƒé™
  };
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆä¼šå‘˜
  if (memberLevel && memberExpiry) {
    const expiryDate = new Date(memberExpiry);
    const now = new Date();
    
    if (expiryDate > now) {
      // æ£€æŸ¥ç­‰çº§æƒé™
      const userWeight = tierWeight[memberLevel] || 0;
      const requiredWeight = tierWeight[pageRequiredTier] || 0;
      
      if (userWeight >= requiredWeight) {
        // æƒé™è¶³å¤Ÿï¼Œéšè—é™åˆ¶æç¤º
        const memberGuard = document.querySelector('.member-content-guard');
        if (memberGuard) {
          memberGuard.style.display = 'none';
        }
        
        // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ·»åŠ ç®¡ç†å‘˜æ ‡è¯†
        if (memberLevel === 'admin') {
          addAdminBadge();
        }
        return;
      }
    }
  }
  
  // æƒé™ä¸è¶³ï¼Œæ˜¾ç¤ºé™åˆ¶æç¤º
  const memberGuard = document.querySelector('.member-content-guard');
  if (memberGuard) {
    memberGuard.style.display = 'block';
  }
})();

// å¿«é€ŸéªŒè¯è®¿é—®ç ï¼ˆåœ¨æ–‡ç« é¡µé¢ç›´æ¥ä½¿ç”¨ï¼‰
function quickVerifyAccess() {
  const accessCode = document.getElementById('quickAccessCode').value.trim();
  const messageDiv = document.getElementById('quick-auth-message');
  
  if (!accessCode) {
    showQuickMessage('è¯·è¾“å…¥è®¿é—®ç ', 'error');
    return;
  }
  
  // éªŒè¯è®¿é—®ç æ ¼å¼å’Œæœ‰æ•ˆæ€§
  const result = validateAccessCode(accessCode);
  
  if (result.valid) {
    // ä¿å­˜ä¼šå‘˜çŠ¶æ€
    localStorage.setItem('memberAccess', 'true');
    localStorage.setItem('memberLevel', result.level);
    localStorage.setItem('memberExpiry', result.expiry);
    
    // Google Analyticsè·Ÿè¸ªä¼šå‘˜è®¿é—®
    if (window.analytics && window.analytics.trackMemberAccess) {
      window.analytics.trackMemberAccess(result.level, 'verification_code');
    }
    
    const message = result.isAdmin ? 
      `ğŸ”§ ç®¡ç†å‘˜è®¿é—®éªŒè¯æˆåŠŸï¼æœ‰æ•ˆæœŸè‡³ ${result.expiry}` :
      `âœ… éªŒè¯æˆåŠŸï¼${result.levelName}ï¼Œæœ‰æ•ˆæœŸè‡³ ${result.expiry}`;
    showQuickMessage(message, 'success');
    
    // éšè—ä¼šå‘˜é™åˆ¶æç¤ºï¼Œæ˜¾ç¤ºå†…å®¹
    setTimeout(() => {
      const memberGuard = document.querySelector('.member-content-guard');
      const restrictedContent = document.getElementById('member-restricted-content');
      
      if (memberGuard) memberGuard.style.display = 'none';
      if (restrictedContent) restrictedContent.style.display = 'block';
      
      // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ·»åŠ ç®¡ç†å‘˜æ ‡è¯†
      if (result.isAdmin) {
        addAdminBadge();
      }
      
      // é¡µé¢åˆ·æ–°ä»¥ç¡®ä¿æ‰€æœ‰è„šæœ¬æ­£ç¡®æ‰§è¡Œ
      setTimeout(() => {
        location.reload();
      }, 1000);
      
    }, 1500);
    
  } else {
    showQuickMessage('âŒ è®¿é—®ç æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥åé‡è¯•', 'error');
  }
}

// æ˜¾ç¤ºå¿«é€ŸéªŒè¯æ¶ˆæ¯
function showQuickMessage(message, type) {
  const messageDiv = document.getElementById('quick-auth-message');
  if (!messageDiv) return;
  
  messageDiv.style.display = 'block';
  messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
  
  if (type === 'success') {
    messageDiv.style.cssText += 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;';
  } else {
    messageDiv.style.cssText += 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;';
  }
  
  messageDiv.innerHTML = message;
}

// è®¿é—®ç éªŒè¯å‡½æ•°ï¼ˆå¤ç”¨ä¼šå‘˜ä¸“åŒºçš„é€»è¾‘ï¼‰
function validateAccessCode(code) {
  // æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
  // 1. æ™®é€šä¼šå‘˜ç ï¼šLEVEL_EXPIRY_RANDOM (å¦‚ï¼šVIP1_YYYYMMDD_XXXX)
  // 2. ç®¡ç†å‘˜ç ï¼šADMIN_EXPIRY_RANDOM (å¦‚ï¼šADMIN_YYYYMMDD_XXXXXX)
  const parts = code.split('_');
  
  if (parts.length !== 3) {
    return { valid: false };
  }
  
  const levelCode = parts[0];
  const expiryDate = parts[1];
  const randomPart = parts[2];
  
  // éªŒè¯æ—¥æœŸæ ¼å¼å’Œæ˜¯å¦è¿‡æœŸ
  if (!/^\d{8}$/.test(expiryDate)) {
    return { valid: false };
  }
  
  const expiry = new Date(
    parseInt(expiryDate.substr(0, 4)),
    parseInt(expiryDate.substr(4, 2)) - 1,
    parseInt(expiryDate.substr(6, 2))
  );
  
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  
  if (expiry < now) {
    return { valid: false };
  }
  
  // ç®¡ç†å‘˜è®¿é—®ç éªŒè¯
  if (levelCode === 'ADMIN') {
    return {
      valid: true,
      level: 'admin',
      levelCode: 'ADMIN',
      levelName: 'ç®¡ç†å‘˜',
      expiry: expiry.toLocaleDateString('zh-CN'),
      isAdmin: true
    };
  }
  
  // æ™®é€šä¼šå‘˜ç éªŒè¯
  const levelMap = {
    'VIP1': { name: 'ä½“éªŒä¼šå‘˜', level: 'experience' },
    'VIP2': { name: 'æœˆåº¦ä¼šå‘˜', level: 'monthly' },
    'VIP3': { name: 'å­£åº¦ä¼šå‘˜', level: 'quarterly' },
    'VIP4': { name: 'å¹´åº¦ä¼šå‘˜', level: 'yearly' }
  };
  
  if (!levelMap[levelCode]) {
    return { valid: false };
  }
  
  return {
    valid: true,
    level: levelMap[levelCode].level,
    levelName: levelMap[levelCode].name,
    levelCode: levelCode,
    expiry: expiry.toLocaleDateString('zh-CN'),
    isAdmin: false
  };
}

// æ·»åŠ ç®¡ç†å‘˜æ ‡è¯†
function addAdminBadge() {
  // é¿å…é‡å¤æ·»åŠ 
  if (document.querySelector('.admin-badge')) return;
  
  const badge = document.createElement('div');
  badge.className = 'admin-badge';
  badge.innerHTML = 'ğŸ”§ ç®¡ç†å‘˜æ¨¡å¼';
  badge.style.cssText = `
    position: fixed;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(220,53,69,0.3);
  `;
  document.body.appendChild(badge);
}

// æ”¯æŒå›è½¦é”®å¿«é€ŸéªŒè¯
document.addEventListener('DOMContentLoaded', function() {
  const quickAccessInput = document.getElementById('quickAccessCode');
  if (quickAccessInput) {
    quickAccessInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        quickVerifyAccess();
      }
    });
  }
});
</script>
{% endif %}